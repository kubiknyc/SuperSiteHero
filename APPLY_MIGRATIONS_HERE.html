<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apply Migrations 046 & 047</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2563eb;
            border-bottom: 3px solid #2563eb;
            padding-bottom: 10px;
        }
        h2 {
            color: #1e40af;
            margin-top: 30px;
        }
        .step {
            background: #f0f9ff;
            border-left: 4px solid #2563eb;
            padding: 15px;
            margin: 15px 0;
        }
        .sql-box {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 6px;
            position: relative;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            overflow-x: auto;
        }
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .copy-btn:hover {
            background: #2563eb;
        }
        .copy-btn:active {
            background: #1d4ed8;
        }
        .success {
            color: #059669;
            font-weight: bold;
        }
        .warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin: 15px 0;
        }
        .danger {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            padding: 15px;
            margin: 15px 0;
        }
        .link-btn {
            display: inline-block;
            background: #10b981;
            color: white;
            padding: 12px 24px;
            text-decoration: none;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: 600;
        }
        .link-btn:hover {
            background: #059669;
        }
        ol {
            line-height: 2;
        }
        pre {
            margin: 0;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Fix 403 Project Creation Error - Migrations 046 & 047</h1>

        <div class="danger">
            <strong>‚ö†Ô∏è IMPORTANT:</strong> Your application code is correct! This is a database configuration fix only.
        </div>

        <h2>üìã Quick Instructions</h2>

        <div class="step">
            <strong>Step 1:</strong> Click this button to open Supabase SQL Editor:
            <br><br>
            <a href="https://supabase.com/dashboard/project/nxlznnrocrffnbzjaaae/sql/new" target="_blank" class="link-btn">
                üöÄ Open Supabase SQL Editor
            </a>
        </div>

        <div class="step">
            <strong>Step 2:</strong> Copy Migration 046 SQL below and paste it in the SQL Editor, then click "Run"
        </div>

        <div class="step">
            <strong>Step 3:</strong> Copy Migration 047 SQL below and paste it in the SQL Editor (new query), then click "Run"
        </div>

        <div class="step">
            <strong>Step 4:</strong> Log out and log back in to your application
        </div>

        <div class="step">
            <strong>Step 5:</strong> Try creating a project - should work! ‚úÖ
        </div>

        <hr style="margin: 40px 0;">

        <h2>üìù Migration 046: Fix Projects INSERT Policy</h2>
        <p>This fixes the overly permissive policy that was causing 403 errors.</p>

        <div class="sql-box">
            <button class="copy-btn" onclick="copyMigration046()">üìã Copy</button>
            <pre id="migration046">-- Migration 046: Fix Projects INSERT Policy
-- Drop the overly permissive policy
DROP POLICY IF EXISTS "Authenticated users can insert projects" ON projects;

-- Create a proper policy that validates company_id
CREATE POLICY "Authenticated users can insert projects in their company"
  ON projects FOR INSERT
  WITH CHECK (
    -- User must be authenticated
    auth.uid() IS NOT NULL
    -- company_id must not be NULL
    AND company_id IS NOT NULL
    -- company_id must match the user's company
    AND company_id = (SELECT company_id FROM users WHERE id = auth.uid())
  );

-- Add helpful comment
COMMENT ON POLICY "Authenticated users can insert projects in their company" ON projects IS
  'Allows authenticated users to create projects for their company.
   Validates:
   - User is authenticated (auth.uid() IS NOT NULL)
   - company_id is provided (NOT NULL)
   - company_id matches user company (multi-tenant isolation)';</pre>
        </div>

        <hr style="margin: 40px 0;">

        <h2>üìù Migration 047: Fix Users SELECT Recursion</h2>
        <p>This fixes the RLS recursion issue that was causing unpredictable behavior.</p>

        <div class="sql-box">
            <button class="copy-btn" onclick="copyMigration047()">üìã Copy</button>
            <pre id="migration047">-- Migration 047: Fix Users SELECT Recursion

-- Create a security definer function to get user's company_id
CREATE OR REPLACE FUNCTION auth.user_company_id()
RETURNS uuid
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT company_id
  FROM users
  WHERE id = auth.uid()
  LIMIT 1;
$$;

COMMENT ON FUNCTION auth.user_company_id() IS
  'Returns the company_id for the currently authenticated user.
   Uses SECURITY DEFINER to bypass RLS and prevent recursion.';

-- Grant execute permission to authenticated users
GRANT EXECUTE ON FUNCTION auth.user_company_id() TO authenticated;

-- Drop the existing recursive policy
DROP POLICY IF EXISTS "Users can view company users" ON users;

-- Create a new non-recursive policy using the function
CREATE POLICY "Users can view company users"
  ON users FOR SELECT
  USING (
    -- Allow users to see other users in their company
    company_id = auth.user_company_id()
    -- Also allow users to always see themselves
    OR id = auth.uid()
  );

COMMENT ON POLICY "Users can view company users" ON users IS
  'Allows users to view other users in their company.
   Uses auth.user_company_id() function to avoid RLS recursion.';

-- Create function for role check (bonus helper)
CREATE OR REPLACE FUNCTION auth.user_role()
RETURNS text
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT role
  FROM users
  WHERE id = auth.uid()
  LIMIT 1;
$$;

COMMENT ON FUNCTION auth.user_role() IS
  'Returns the role for the currently authenticated user.
   Can be used in RLS policies that need role-based checks.';

GRANT EXECUTE ON FUNCTION auth.user_role() TO authenticated;</pre>
        </div>

        <hr style="margin: 40px 0;">

        <h2>‚úÖ Verification (Optional)</h2>
        <p>After applying both migrations, you can run this query to verify they were applied correctly:</p>

        <div class="sql-box">
            <button class="copy-btn" onclick="copyVerification()">üìã Copy</button>
            <pre id="verification">-- Verify migrations were applied

-- Check projects INSERT policy
SELECT policyname, cmd
FROM pg_policies
WHERE tablename = 'projects' AND cmd = 'INSERT';
-- Expected: "Authenticated users can insert projects in their company"

-- Check users SELECT policy
SELECT policyname, cmd
FROM pg_policies
WHERE tablename = 'users' AND cmd = 'SELECT';
-- Expected: "Users can view company users"

-- Check helper functions exist
SELECT routine_name, security_type
FROM information_schema.routines
WHERE routine_schema = 'auth'
  AND routine_name IN ('user_company_id', 'user_role');
-- Expected: Two rows with DEFINER security type</pre>
        </div>

        <hr style="margin: 40px 0;">

        <div class="warning">
            <strong>‚ö†Ô∏è CRITICAL:</strong> After applying these migrations, you <strong>MUST</strong> log out and log back in to your application for the RLS policy changes to take effect!
        </div>

        <div class="success">
            ‚úÖ Once applied, your 403 error should be fixed and you'll be able to create projects!
        </div>

    </div>

    <script>
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Success feedback
            });
        }

        function copyMigration046() {
            const text = document.getElementById('migration046').textContent;
            copyToClipboard(text);
            const btn = event.target;
            btn.textContent = '‚úÖ Copied!';
            btn.style.background = '#10b981';
            setTimeout(() => {
                btn.textContent = 'üìã Copy';
                btn.style.background = '#3b82f6';
            }, 2000);
        }

        function copyMigration047() {
            const text = document.getElementById('migration047').textContent;
            copyToClipboard(text);
            const btn = event.target;
            btn.textContent = '‚úÖ Copied!';
            btn.style.background = '#10b981';
            setTimeout(() => {
                btn.textContent = 'üìã Copy';
                btn.style.background = '#3b82f6';
            }, 2000);
        }

        function copyVerification() {
            const text = document.getElementById('verification').textContent;
            copyToClipboard(text);
            const btn = event.target;
            btn.textContent = '‚úÖ Copied!';
            btn.style.background = '#10b981';
            setTimeout(() => {
                btn.textContent = 'üìã Copy';
                btn.style.background = '#3b82f6';
            }, 2000);
        }
    </script>
</body>
</html>