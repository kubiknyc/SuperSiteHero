name: Auto-Fix CI

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]
  push:
    branches-ignore:
      - main
      - develop
      - 'release/*'

# Prevent concurrent runs on the same PR to avoid conflicts
concurrency:
  group: auto-fix-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

env:
  NODE_VERSION: '20'
  NODE_OPTIONS: '--max-old-space-size=8192'

jobs:
  # ==================== DETECTION PHASE ====================
  detect-issues:
    name: Detect Issues
    runs-on: ubuntu-latest
    outputs:
      has_lint_errors: ${{ steps.lint-check.outputs.has_errors }}
      has_type_errors: ${{ steps.type-check.outputs.has_errors }}
      has_test_failures: ${{ steps.test-check.outputs.has_failures }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if triggered by bot
        id: check-bot
        run: |
          AUTHOR="${{ github.event.head_commit.author.name }}"
          if [[ "$AUTHOR" == "github-actions[bot]" ]]; then
            echo "is_bot=true" >> $GITHUB_OUTPUT
            echo "Skipping: triggered by bot commit"
          else
            echo "is_bot=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        if: steps.check-bot.outputs.is_bot != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        if: steps.check-bot.outputs.is_bot != 'true'
        run: npm ci --legacy-peer-deps

      - name: Check ESLint issues
        id: lint-check
        if: steps.check-bot.outputs.is_bot != 'true'
        continue-on-error: true
        run: |
          set +e
          npm run lint 2>&1
          EXIT_CODE=$?
          if [ $EXIT_CODE -ne 0 ]; then
            echo "has_errors=true" >> $GITHUB_OUTPUT
          else
            echo "has_errors=false" >> $GITHUB_OUTPUT
          fi

      - name: Check TypeScript errors
        id: type-check
        if: steps.check-bot.outputs.is_bot != 'true'
        continue-on-error: true
        run: |
          set +e
          npm run type-check 2>&1
          EXIT_CODE=$?
          if [ $EXIT_CODE -ne 0 ]; then
            echo "has_errors=true" >> $GITHUB_OUTPUT
          else
            echo "has_errors=false" >> $GITHUB_OUTPUT
          fi

      - name: Check test failures
        id: test-check
        if: steps.check-bot.outputs.is_bot != 'true'
        continue-on-error: true
        run: |
          set +e
          npm run test:unit -- --run 2>&1
          EXIT_CODE=$?
          if [ $EXIT_CODE -ne 0 ]; then
            echo "has_failures=true" >> $GITHUB_OUTPUT
          else
            echo "has_failures=false" >> $GITHUB_OUTPUT
          fi
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

  # ==================== ESLint AUTO-FIX ====================
  fix-eslint:
    name: Fix ESLint Issues
    needs: detect-issues
    if: needs.detect-issues.outputs.has_lint_errors == 'true'
    runs-on: ubuntu-latest
    outputs:
      files_changed: ${{ steps.check-changes.outputs.files_changed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run ESLint auto-fix
        run: npm run lint:fix || true

      - name: Check for changes
        id: check-changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "files_changed=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git status --short
          else
            echo "files_changed=false" >> $GITHUB_OUTPUT
            echo "No changes to commit"
          fi

      - name: Commit ESLint fixes
        if: steps.check-changes.outputs.files_changed == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "fix: auto-fix ESLint issues

          This commit was automatically generated by the CI auto-fix workflow.

          Changes applied:
          - ESLint auto-fixable issues resolved
          - Code formatting corrections

          [skip ci]"
          git push origin HEAD:${{ github.head_ref || github.ref_name }}

  # ==================== TypeScript FIX SUGGESTIONS ====================
  suggest-typescript-fixes:
    name: Suggest TypeScript Fixes
    needs: [detect-issues, fix-eslint]
    if: |
      always() &&
      needs.detect-issues.outputs.has_type_errors == 'true' &&
      (needs.fix-eslint.result == 'success' || needs.fix-eslint.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull latest changes
        run: git pull origin ${{ github.head_ref || github.ref_name }} || true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Analyze TypeScript errors
        id: analyze
        run: |
          npm run type-check 2>&1 | tee typescript-errors.log || true

          # Count error types
          TOTAL=$(grep -c "error TS" typescript-errors.log || echo "0")
          MISSING_IMPORT=$(grep -c "Cannot find module" typescript-errors.log || echo "0")
          TYPE_MISMATCH=$(grep -c "is not assignable" typescript-errors.log || echo "0")
          MISSING_PROP=$(grep -c "does not exist on type" typescript-errors.log || echo "0")
          NULL_CHECK=$(grep -c "possibly" typescript-errors.log || echo "0")

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "missing_import=$MISSING_IMPORT" >> $GITHUB_OUTPUT
          echo "type_mismatch=$TYPE_MISMATCH" >> $GITHUB_OUTPUT
          echo "missing_prop=$MISSING_PROP" >> $GITHUB_OUTPUT
          echo "null_check=$NULL_CHECK" >> $GITHUB_OUTPUT

      - name: Comment on PR with TypeScript analysis
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let errorLog = '';
            try {
              errorLog = fs.readFileSync('typescript-errors.log', 'utf8');
            } catch (e) {
              errorLog = 'Unable to read error log';
            }

            // Truncate if too long
            if (errorLog.length > 60000) {
              errorLog = errorLog.substring(0, 60000) + '\n... (truncated)';
            }

            const total = '${{ steps.analyze.outputs.total }}';
            const missingImport = '${{ steps.analyze.outputs.missing_import }}';
            const typeMismatch = '${{ steps.analyze.outputs.type_mismatch }}';
            const missingProp = '${{ steps.analyze.outputs.missing_prop }}';
            const nullCheck = '${{ steps.analyze.outputs.null_check }}';

            const body = `## TypeScript Errors Detected (${total} total)

            | Error Type | Count |
            |------------|-------|
            | Missing Imports | ${missingImport} |
            | Type Mismatches | ${typeMismatch} |
            | Missing Properties | ${missingProp} |
            | Null/Undefined Checks | ${nullCheck} |

            <details>
            <summary>Click to expand error details</summary>

            \`\`\`
            ${errorLog}
            \`\`\`

            </details>

            ### Common Fixes:
            - **Missing imports**: Add the required import statement
            - **Type mismatches**: Check the expected type and update accordingly
            - **Null checks**: Add optional chaining (\`?.\`) or null coalescing (\`??\`)
            - **Missing properties**: Update the interface or add the property

            > This comment was generated by the auto-fix workflow.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # ==================== TEST FAILURE ANALYSIS ====================
  analyze-test-failures:
    name: Analyze Test Failures
    needs: [detect-issues, fix-eslint, suggest-typescript-fixes]
    if: |
      always() &&
      needs.detect-issues.outputs.has_test_failures == 'true' &&
      (needs.fix-eslint.result == 'success' || needs.fix-eslint.result == 'skipped') &&
      (needs.suggest-typescript-fixes.result == 'success' || needs.suggest-typescript-fixes.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull latest changes
        run: git pull origin ${{ github.head_ref || github.ref_name }} || true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run tests with detailed output
        id: test-details
        continue-on-error: true
        run: |
          npm run test:unit -- --run 2>&1 | tee test-output.log
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Attempt snapshot updates
        id: snapshot-update
        run: |
          # Check if snapshot mismatch detected
          if grep -q "Snapshot" test-output.log; then
            echo "Updating snapshots..."
            npm run test:unit -- --run --update 2>/dev/null || true

            # Check for changes
            if [ -n "$(git status --porcelain)" ]; then
              echo "snapshots_updated=true" >> $GITHUB_OUTPUT
            else
              echo "snapshots_updated=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "snapshots_updated=false" >> $GITHUB_OUTPUT
          fi
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Commit snapshot updates
        if: steps.snapshot-update.outputs.snapshots_updated == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "fix: update test snapshots

          Automatically updated test snapshots to match current component output.

          [skip ci]"
          git push origin HEAD:${{ github.head_ref || github.ref_name }}

      - name: Comment on PR with test analysis
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let testOutput = '';
            try {
              testOutput = fs.readFileSync('test-output.log', 'utf8');
            } catch (e) {
              testOutput = 'Unable to read test output';
            }

            // Extract failing tests
            const lines = testOutput.split('\n');
            const failingTests = lines
              .filter(line => line.includes('FAIL') || line.includes('Error') || line.includes('expected'))
              .slice(0, 50)
              .join('\n');

            const snapshotsUpdated = '${{ steps.snapshot-update.outputs.snapshots_updated }}' === 'true';

            const body = `## Test Failures Detected

            ${snapshotsUpdated ? '### Automatic Actions Taken:\n- Updated snapshots\n' : ''}

            <details>
            <summary>Click to expand failing tests</summary>

            \`\`\`
            ${failingTests || 'See full output in workflow logs'}
            \`\`\`

            </details>

            ### Manual Steps Required:
            1. Review the failing assertions
            2. Update test expectations or fix the implementation
            3. Run \`npm run test:unit\` locally to verify

            > This comment was generated by the auto-fix workflow.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # ==================== VERIFICATION ====================
  verify-fixes:
    name: Verify All Fixes
    needs: [detect-issues, fix-eslint, suggest-typescript-fixes, analyze-test-failures]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code (with latest changes)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull latest changes
        run: git pull origin ${{ github.head_ref || github.ref_name }} || true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Verify ESLint
        id: verify-lint
        continue-on-error: true
        run: npm run lint

      - name: Verify TypeScript
        id: verify-types
        continue-on-error: true
        run: npm run type-check

      - name: Verify Tests
        id: verify-tests
        continue-on-error: true
        run: npm run test:unit -- --run
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Verify Build
        id: verify-build
        continue-on-error: true
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Create verification summary
        run: |
          echo "## Auto-Fix Verification Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ESLint | ${{ steps.verify-lint.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript | ${{ steps.verify-types.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ steps.verify-tests.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ steps.verify-build.outcome }} |" >> $GITHUB_STEP_SUMMARY

      - name: Update PR status
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const lintStatus = '${{ steps.verify-lint.outcome }}';
            const typeStatus = '${{ steps.verify-types.outcome }}';
            const testStatus = '${{ steps.verify-tests.outcome }}';
            const buildStatus = '${{ steps.verify-build.outcome }}';

            const allPassed = lintStatus === 'success' &&
                              typeStatus === 'success' &&
                              testStatus === 'success' &&
                              buildStatus === 'success';

            const statusEmoji = allPassed ? 'All checks passing after auto-fix!' : 'Some checks still failing - manual review required.';

            const hadLintErrors = '${{ needs.detect-issues.outputs.has_lint_errors }}' === 'true';
            const hadTypeErrors = '${{ needs.detect-issues.outputs.has_type_errors }}' === 'true';
            const hadTestFailures = '${{ needs.detect-issues.outputs.has_test_failures }}' === 'true';

            const body = `## Auto-Fix Results

            ${statusEmoji}

            | Check | Before | After |
            |-------|--------|-------|
            | ESLint | ${hadLintErrors ? 'Issues' : 'OK'} | ${lintStatus === 'success' ? 'OK' : 'Issues'} |
            | TypeScript | ${hadTypeErrors ? 'Errors' : 'OK'} | ${typeStatus === 'success' ? 'OK' : 'Errors'} |
            | Unit Tests | ${hadTestFailures ? 'Failing' : 'OK'} | ${testStatus === 'success' ? 'OK' : 'Failing'} |
            | Build | - | ${buildStatus === 'success' ? 'OK' : 'Failed'} |

            ${!allPassed ? `
            ### Next Steps:
            1. Pull the latest changes: \`git pull\`
            2. Review the auto-fix commits
            3. Address remaining issues manually
            ` : ''}

            > Auto-fix workflow completed at ${new Date().toISOString()}`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
