# Autonomous E2E Testing Workflow
#
# This workflow runs comprehensive E2E tests in phases with advanced features:
# 1. Critical Tests (Auth, Offline) - must pass first
# 2. CRUD Tests - parallel execution
# 3. Workflow Tests - parallel execution
# 4. Feature Tests - sharded execution for faster runs
# 5. Quality Tests - multi-browser (Chromium, Firefox, WebKit)
#
# Triggers:
# - Every 6 hours (scheduled) - continuous monitoring
# - Manual dispatch - on-demand testing

name: Autonomous E2E Tests - Scheduled

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:
    inputs:
      test_phase:
        description: 'Test phase to run (all, critical, crud, workflow, feature, quality)'
        required: false
        default: 'all'

env:
  VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
  VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
  TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
  TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
  NODE_OPTIONS: '--max-old-space-size=4096'

jobs:
  # ============================================
  # Phase 1: Critical Path Tests
  # ============================================
  critical-tests:
    name: Critical Path Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      status: ${{ steps.run-tests.outcome }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run Critical Tests
        id: run-tests
        run: |
          npx playwright test \
            e2e/auth*.spec.ts \
            e2e/offline*.spec.ts \
            --project=chromium \
            --reporter=html,json
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: critical-test-results
          path: |
            playwright-report/
            test-results/
          retention-days: 30

  # ============================================
  # Phase 2: CRUD Tests
  # ============================================
  crud-tests:
    name: CRUD Tests
    needs: critical-tests
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run CRUD Tests
        run: |
          npx playwright test \
            e2e/projects.spec.ts \
            e2e/daily-reports.spec.ts \
            e2e/tasks.spec.ts \
            e2e/punch-lists.spec.ts \
            e2e/checklists.spec.ts \
            --project=chromium \
            --reporter=html,json
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: crud-test-results
          path: |
            playwright-report/
            test-results/
          retention-days: 30

  # ============================================
  # Phase 3: Workflow Tests
  # ============================================
  workflow-tests:
    name: Workflow Tests
    needs: critical-tests
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run Workflow Tests
        run: |
          npx playwright test \
            e2e/workflows.spec.ts \
            e2e/rfis.spec.ts \
            e2e/submittals.spec.ts \
            e2e/change-orders.spec.ts \
            e2e/inspections.spec.ts \
            --project=chromium \
            --reporter=html,json
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: workflow-test-results
          path: |
            playwright-report/
            test-results/
          retention-days: 30

  # ============================================
  # Phase 4: Feature Tests (Sharded)
  # ============================================
  feature-tests:
    name: Feature Tests (Shard ${{ matrix.shard }})
    needs: [crud-tests, workflow-tests]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run Feature Tests (Shard ${{ matrix.shard }})
        run: |
          npx playwright test \
            e2e/documents.spec.ts \
            e2e/photo*.spec.ts \
            e2e/safety*.spec.ts \
            e2e/meetings.spec.ts \
            e2e/schedule.spec.ts \
            --shard=${{ matrix.shard }}/4 \
            --project=chromium \
            --reporter=html,json
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: feature-test-results-shard-${{ matrix.shard }}
          path: |
            playwright-report/
            test-results/
          retention-days: 30

  # ============================================
  # Phase 5: Quality Tests (Multi-browser)
  # ============================================
  quality-tests:
    name: Quality Tests (${{ matrix.project }})
    needs: feature-tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        project: [chromium, firefox, webkit]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Install Playwright browsers
        run: npx playwright install --with-deps ${{ matrix.project }}

      - name: Run Quality Tests (${{ matrix.project }})
        run: |
          npx playwright test \
            e2e/accessibility/ \
            e2e/blueprint-variants-responsive.spec.ts \
            e2e/performance/ \
            --project=${{ matrix.project }} \
            --reporter=html,json
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: quality-test-results-${{ matrix.project }}
          path: |
            playwright-report/
            test-results/
          retention-days: 30

  # ============================================
  # Phase 6: Portal Tests
  # ============================================
  portal-tests:
    name: Portal Tests
    needs: critical-tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run Portal Tests
        run: |
          npx playwright test \
            e2e/subcontractor-portal.spec.ts \
            --project=chromium \
            --reporter=html,json
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: portal-test-results
          path: |
            playwright-report/
            test-results/
          retention-days: 30

  # ============================================
  # Generate Report Summary
  # ============================================
  report:
    name: Generate Report
    needs: [critical-tests, crud-tests, workflow-tests, feature-tests, quality-tests, portal-tests]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-results

      - name: Generate Summary
        run: |
          echo "## Autonomous E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Phase | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Critical Tests | ${{ needs.critical-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CRUD Tests | ${{ needs.crud-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow Tests | ${{ needs.workflow-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Feature Tests | ${{ needs.feature-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Tests | ${{ needs.quality-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Portal Tests | ${{ needs.portal-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View detailed reports in the workflow artifacts." >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: ${{ needs.critical-tests.result == 'failure' || needs.crud-tests.result == 'failure' }}
        run: |
          echo "::error::Critical or CRUD tests failed! Check the test results."
